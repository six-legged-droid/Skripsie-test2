<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QC Dashboard — Torque Wrench</title>
<style>
  :root { --bg:#0b0f17; --card:#121826; --text:#e6eefc; --muted:#9fb0c9; --ok:#91f2a1; --bad:#ff9aa9; --accent:#3b82f6; }
  body { margin:0; background:var(--bg); color:var(--text); font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial; }
  header { padding:20px 16px; }
  h1 { margin:0 0 4px; font-weight:800; }
  #status { color:var(--muted) }
  .container { max-width:1200px; margin:0 auto 48px; padding:0 16px; }
  .kpis { display:grid; grid-template-columns: repeat(4,minmax(180px,1fr)); gap:12px; margin:12px 0 20px; }
  .kpi { background:var(--card); border-radius:14px; padding:14px 16px; box-shadow:0 10px 24px rgba(0,0,0,.25); }
  .kpi h3 { margin:0 0 6px; font-size:12px; letter-spacing:.06em; color:var(--muted); font-weight:700; text-transform:uppercase; }
  .kpi .v { font-size:28px; font-weight:800; }
  .controls { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin:10px 0 18px; }
  .controls .group { background:var(--card); border-radius:12px; padding:8px 10px; box-shadow:0 10px 24px rgba(0,0,0,.25); display:flex; gap:8px; align-items:center; }
  select, button, input[type="text"], input[type="search"] { appearance:none; border:1px solid rgba(255,255,255,.12); background:#0f172a; color:var(--text); border-radius:8px; padding:8px 10px; }
  button.primary { background:var(--accent); border:0; font-weight:700; }
  .tabs { display:flex; gap:8px; margin:6px 0 12px; }
  .tab { background:transparent; border:1px solid rgba(255,255,255,.2); color:var(--text); border-radius:999px; padding:6px 12px; cursor:pointer; }
  .tab.active { background:var(--accent); border-color:var(--accent); font-weight:700; }
  .panel { background:var(--card); border-radius:16px; padding:12px; box-shadow:0 10px 24px rgba(0,0,0,.25); }
  table { width:100%; border-collapse:collapse; }
  th, td { padding:10px 12px; text-align:left; border-bottom:1px solid rgba(255,255,255,.08); }
  th { color:var(--muted); font-weight:600; letter-spacing:.02em; background:var(--card); position:sticky; top:0; }
  tr.fail { background:#2b1010; }
  tr.fail td { color:#ffb3b3; }
  .pill { padding:3px 8px; border-radius:999px; font-weight:700; font-size:12px; display:inline-block; }
  .ok  { background:#15321c; color:var(--ok); }
  .bad { background:#3a1414; color:var(--bad); }
  .toolbar { display:flex; justify-content:space-between; align-items:center; margin:0 0 8px; }
  .muted { color:var(--muted) }
  .hide { display:none; }
  .small { font-size:12px; color:var(--muted); }
  .badge { display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.2); margin-left:8px; }
</style>
</head>
<body>
<header class="container">
  <h1>QC Dashboard — device001 <span id="activeProjectBadge" class="badge"></span></h1>
  <p id="status">Connecting…</p>
</header>

<main class="container">
  <!-- KPIs -->
  <section class="kpis">
    <div class="kpi"><h3>Total</h3><div class="v" id="k_total">0</div></div>
    <div class="kpi"><h3>Pass Rate</h3><div class="v" id="k_pass">0%</div></div>
    <div class="kpi"><h3>Failures</h3><div class="v" id="k_fail">0</div></div>
    <div class="kpi"><h3>Last Fail</h3><div class="v" id="k_lastfail">—</div></div>
  </section>

  <!-- Controls -->
  <div class="controls">
    <div class="group">
      <span class="muted">Project</span>
      <select id="projectSelect"><option value="ALL" selected>All projects</option></select>
      <button id="setActiveProject" class="primary">Set Active on Device</button>
    </div>
    <div class="group">
      <input id="newProjectName" type="text" placeholder="New project name">
      <button id="createProject">Create Project</button>
    </div>

    <div class="group"><input id="searchId" type="search" placeholder="Search Bolt ID"></div>

    <div class="group">
      <span class="muted">Time window</span>
      <select id="timeWindow">
        <option value="1">Last 1h</option>
        <option value="6">Last 6h</option>
        <option value="24" selected>Last 24h</option>
        <option value="168">Last 7d</option>
        <option value="0">All</option>
      </select>
    </div>
    <div class="group">
      <span class="muted">Bolt</span>
      <select id="boltFilter">
        <option value="ALL" selected>All sizes</option>
        <option value="M6">M6</option>
        <option value="M8">M8</option>
        <option value="M10">M10</option>
        <option value="M12">M12</option>
      </select>
    </div>
    <div class="group">
      <button id="exportCsv">Export CSV (current view)</button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab" data-tab="failures">Failures</button>
    <button class="tab active" data-tab="all">All logs</button>
  </div>

  <!-- Panels -->
  <section id="panel_failures" class="panel hide">
    <div class="toolbar">
      <h3>Failures</h3>
      <span class="muted" id="f_count">0 rows</span>
    </div>
    <table><thead>
      <tr><th>Time (UTC)</th><th>Project</th><th>Bolt ID</th><th>Bolt</th><th>Grade</th><th>Torque (Nm)</th><th>Desired (Nm)</th><th>Result</th></tr>
    </thead><tbody id="tbody_fail"></tbody></table>
  </section>

  <section id="panel_all" class="panel">
    <div class="toolbar">
      <h3>All logs</h3>
      <span class="muted" id="a_count">0 rows</span>
    </div>
    <table><thead>
      <tr><th>Time (UTC)</th><th>Project</th><th>Bolt ID</th><th>Bolt</th><th>Grade</th><th>Torque (Nm)</th><th>Desired (Nm)</th><th>Result</th></tr>
    </thead><tbody id="tbody_all"></tbody></table>
    <p class="small">Records without a projectId are shown as <em>Unassigned</em>.</p>
  </section>
</main>

<script type="module">
  // ======= CONFIG =======
  const DEVICE_ID = "device001";
  const DB_PATH_TIMESERIES = `devices/${DEVICE_ID}/timeseries`;
  const DB_PATH_DEVICE_CFG = `devices/${DEVICE_ID}/config`;
  const DB_PATH_PROJECTS   = "projects";

  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged }
    from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
  import {
    getDatabase, ref, query, orderByChild, limitToLast, onValue, get, set, push, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB5bM0ipakfKzlAxE588b9gUSBhAyJWOtM",
    authDomain: "digital-torque-wrench-3e1f1.firebaseapp.com",
    databaseURL: "https://digital-torque-wrench-3e1f1-default-rtdb.firebaseio.com",
    projectId: "digital-torque-wrench-3e1f1",
    storageBucket: "digital-torque-wrench-3e1f1.firebasestorage.app",
    messagingSenderId: "904327818991",
    appId: "1:904327818991:web:7879859e48d07c74a1f51a"
  };

  // ======= UI handles =======
  const $ = (sel) => document.querySelector(sel);
  const $status    = $("#status");
  const $activeP   = $("#activeProjectBadge");

  const $tbodyFail = $("#tbody_fail");
  const $tbodyAll  = $("#tbody_all");
  const $kTotal = $("#k_total"), $kPass = $("#k_pass"), $kFail = $("#k_fail"), $kLastFail = $("#k_lastfail");
  const $fCount = $("#f_count"), $aCount = $("#a_count");

  const $timeWindow = $("#timeWindow"), $boltFilter = $("#boltFilter");
  const $searchId = $("#searchId");

  const $projectSelect = $("#projectSelect");
  const $createProject = $("#createProject");
  const $newProjectName = $("#newProjectName");
  const $setActiveProject = $("#setActiveProject");

  const fmt = (n) => (n===undefined || n===null || isNaN(n)) ? "" : Number(n).toFixed(2);
  const when = (t) => t ? new Date(t*1000).toISOString().replace("T"," ").slice(0,19) : "";
  const pname = (id, map) => (id && map[id]?.name) || (id ? id : "Unassigned");

  const rowEl = (r, projectsMap) => {
    const tr = document.createElement("tr");
    if (!r.pass) tr.classList.add("fail");
    tr.innerHTML = `<td>${when(r.timestamp)}</td>
                    <td>${pname(r.projectId, projectsMap)}</td>
                    <td>${r.boltId ?? ""}</td>
                    <td>${r.bolt ?? ""}</td>
                    <td>${r.grade ?? ""}</td>
                    <td>${fmt(r.torque)}</td>
                    <td>${fmt(r.desired)}</td>
                    <td>${r.pass ? '<span class="pill ok">PASS</span>' : '<span class="pill bad">FAIL</span>'}</td>`;
    return tr;
  };

  function hoursToCutoff(h) {
    if (!h || Number(h)===0) return 0;
    const now = Math.floor(Date.now()/1000);
    return now - Number(h)*3600;
  }

  // State
  let PROJECTS = {};           // {projectId: {name, createdAt}}
  let ACTIVE_PROJECT = null;   // active project for the device (from /devices/.../config)
  let FULL = [];

  function applyFilters(allRows) {
    const bolt = $boltFilter.value;
    const cutoff = hoursToCutoff($timeWindow.value);
    const q = ($searchId.value||"").trim();
    const selectedProject = $projectSelect.value; // "ALL" or projectId or "UNASSIGNED"

    return allRows.filter(r => {
      if (bolt !== "ALL" && r.bolt !== bolt) return false;
      if (cutoff && (r.timestamp||0) < cutoff) return false;
      if (q && String(r.boltId||"").indexOf(q) === -1) return false;
      if (selectedProject !== "ALL") {
        if (selectedProject === "UNASSIGNED") {
          if (r.projectId) return false;
        } else {
          if ((r.projectId||"") !== selectedProject) return false;
        }
      }
      return true;
    });
  }

  function toCSV(rows) {
    const header = ["timestamp","time_utc","projectId","projectName","boltId","bolt","grade","torque","desired","pass"];
    const lines = [header.join(",")];
    rows.forEach(r => {
      lines.push([
        r.timestamp||"",
        when(r.timestamp),
        r.projectId||"",
        pname(r.projectId, PROJECTS),
        r.boltId??"",
        r.bolt??"",
        r.grade??"",
        (r.torque??""),
        (r.desired??""),
        r.pass ? "PASS" : "FAIL"
      ].join(","));
    });
    return lines.join("\n");
  }

  const tabBtns = document.querySelectorAll(".tab");
  function setTab(name){
    tabBtns.forEach(b => b.classList.toggle("active", b.dataset.tab===name));
    document.querySelectorAll(".panel").forEach(p => p.classList.add("hide"));
    document.querySelector("#panel_"+name).classList.remove("hide");
  }
  tabBtns.forEach(b => b.addEventListener("click", ()=>setTab(b.dataset.tab)));

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getDatabase(app);

  function render() {
    const total = FULL.length;
    const fail  = FULL.filter(r => !r.pass).length;
    const pass  = total ? Math.round((1 - fail/total)*100) : 0;
    const lastFail = FULL.filter(r => !r.pass).slice(-1)[0];

    $kTotal.textContent = total.toString();
    $kFail.textContent  = fail.toString();
    $kPass.textContent  = pass + "%";
    $kLastFail.textContent = lastFail ? when(lastFail.timestamp) : "—";

    $activeP.textContent = ACTIVE_PROJECT ? `active project: ${pname(ACTIVE_PROJECT, PROJECTS)}` : "no active project";

    const FILT = applyFilters(FULL);

    const FAIL = FILT.filter(r => !r.pass);
    $tbodyFail.replaceChildren(...FAIL.map(r => rowEl(r, PROJECTS)));
    $fCount.textContent = `${FAIL.length} row${FAIL.length!==1?"s":""}`;

    $tbodyAll.replaceChildren(...FILT.map(r => rowEl(r, PROJECTS)));
    $aCount.textContent = `${FILT.length} row${FILT.length!==1?"s":""}`;
  }

  function onData(snap){
    const data = snap.val() || {};
    FULL = Object.values(data).sort((a,b) => (a.timestamp||0) - (b.timestamp||0));
    render();
  }

  function loadProjects() {
    onValue(ref(db, DB_PATH_PROJECTS), (snap) => {
      PROJECTS = snap.val() || {};
      // rebuild select
      const sel = $projectSelect;
      const was = sel.value;
      sel.innerHTML = '<option value="ALL">All projects</option><option value="UNASSIGNED">Unassigned</option>';
      Object.entries(PROJECTS).forEach(([id, p])=>{
        const opt = document.createElement("option");
        opt.value = id; opt.textContent = p?.name || id;
        sel.appendChild(opt);
      });
      // keep previous selection if possible
      if ([...sel.options].some(o => o.value===was)) sel.value = was;
      render();
    });
  }

  async function loadActiveProject() {
    try {
      const snap = await get(ref(db, `${DB_PATH_DEVICE_CFG}/activeProject`));
      ACTIVE_PROJECT = snap.val() || null;
      render();
    } catch (e) { console.error(e); }
  }

  $createProject.addEventListener("click", async ()=>{
    const name = ($newProjectName.value||"").trim();
    if (!name) return alert("Please enter a project name.");
    try {
      const keyRef = push(ref(db, DB_PATH_PROJECTS));
      await set(keyRef, { name, createdAt: serverTimestamp() });
      $newProjectName.value = "";
    } catch (e) {
      console.error(e);
      alert("Failed to create project: " + e.message);
    }
  });

  $setActiveProject.addEventListener("click", async ()=>{
    const sel = $projectSelect.value;
    if (sel==="ALL") return alert("Select a specific project or Unassigned.");
    try {
      await set(ref(db, `${DB_PATH_DEVICE_CFG}/activeProject`), (sel==="UNASSIGNED" ? null : sel));
      ACTIVE_PROJECT = (sel==="UNASSIGNED" ? null : sel);
      render();
      alert("Active project updated for device.");
    } catch (e) {
      console.error(e);
      alert("Failed to set active project: " + e.message);
    }
  });

  document.getElementById("exportCsv").addEventListener("click", ()=>{
    const active = document.querySelector(".tab.active")?.dataset.tab || "all";
    const FILT = applyFilters(FULL);
    let rows = [];
    if (active === "failures") rows = FILT.filter(r => !r.pass);
    if (active === "all")      rows = FILT;
    downloadCSV(`qc_${active}.csv`, toCSV(rows));
  });

  $timeWindow.addEventListener("change", render);
  $boltFilter.addEventListener("change", render);
  $searchId.addEventListener("input", render);
  function downloadCSV(filename, text) {
    const blob = new Blob([text], {type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  }

  onAuthStateChanged(auth, async (user)=>{
    if (!user) return;
    $status.textContent = "Connected (anonymous). Listening for updates…";
    const qRef = query(ref(db, DB_PATH_TIMESERIES), orderByChild("timestamp"), limitToLast(1000));
    onValue(qRef, onData, (err)=>{ console.error(err); $status.textContent = "Read failed: " + err.message; });
    await loadActiveProject();
    loadProjects();
  });
  signInAnonymously(auth).catch(e => { console.error(e); $status.textContent = "Anonymous sign-in failed: " + e.message; });

  // default tab
  function downloadCSV(filename, text) {
    const blob = new Blob([text], {type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  }
  setTab("all");
</script>
</body>
</html>
